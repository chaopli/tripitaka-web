<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>{{title}}</title>
  {% include _base_meta.html %}

  <!-- Plugins css -->
  <link href="{{ static_url('assets/modal-effect/css/component.css') }}" rel="stylesheet">

  <!-- Custom Files -->
  <link href="{{ static_url('css/helper.css') }}" rel="stylesheet" type="text/css"/>
  <link href="{{ static_url('css/style.css') }}" rel="stylesheet" type="text/css"/>

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
  <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
  <![endif]-->

  {% include _base_css.html %}
  <link href="{{ static_url('css/cut.css') }}" rel="stylesheet" type="text/css"/>

  <style>
    .m-header {
        position: fixed;
        z-index: 1000;
    }
    .full-bd.block {
      margin: auto;
      width: 40%;
    }
    .full-bd.column {
      margin: auto;
      width: 40%;
    }
    .full-bd.char {
      margin: auto;
      width: 90%;
    }
  </style>
</head>

<body class="widescreen">
  <div class="app-main">
    <div class="main">
      <div class="main-content">

        <div class="m-header">
          <div class="left">
            {% if can_return %}
              <img src='{{ static_url("imgs/icon_back.png") }}' class="m-header-img fl" onclick="leave('{{from_url}}')"/>
            {% else %}
              <img src='{{ static_url("imgs/frame/icon_task_lobby.png") }}' class="m-header-img fl" onclick="leave('{{from_url}}')"/>
            {% end %}
            <div class="m-header-title" title="{{page['name']}}">{{title}}</div>
            <div class="slice-btn-group">
              <div class="btn-group hl-btn">
                <button type="button" class="btn btn-default btn-sm" id="hl-all">所有<sup class="s-h-count"></sup></button>
                <button type="button" class="btn btn-default btn-sm" id="hl-overlap">重叠<sup class="s-h-count"></sup></button>
                {% if box_type == 'char' %}
                <button type="button" class="btn btn-default btn-sm" id="hl-large">大框<sup class="s-h-count"></sup></button>
                <button type="button" class="btn btn-default btn-sm" id="hl-small">小框<sup class="s-h-count"></sup></button>
                <button type="button" class="btn btn-default btn-sm" id="hl-narrow">窄框<sup class="s-h-count"></sup></button>
                <button type="button" class="btn btn-default btn-sm" id="hl-flat">扁框<sup class="s-h-count"></sup></button>
                {% end %}
              </div>
            </div>
            <div class="m-header-edit-btn">
              <img src="{{ static_url('imgs/icon_aim.png') }}" class="m-header-img btn-cut-show" title="全屏"/>
              <img src="{{ static_url('imgs/icon_zoom1.png') }}" class="m-header-img btn-enlarge" title="放大"/>
              <img src="{{ static_url('imgs/icon_zoom2.png') }}" class="m-header-img btn-reduce" title="缩小"/>
              <img src="{{ static_url('imgs/icon_lr.png') }}" class="m-header-img undo" title="撤销"/>
              <img src="{{ static_url('imgs/icon_rr.png') }}" class="m-header-img redo" title="重做"/>
            </div>
            {% if box_type in ['column', 'char'] %}
            <div class="more">
              <img src="{{ static_url('imgs/icon_box.png') }}" class="m-header-img btn-ed-box fl" title="更多"/>
              <div class="btn-group ed-box-group hidden" role="group" aria-label="更多" style="margin-top: 5px">
                {% set more = dict(column=[('block', '栏框')],char=[('block', '栏框'), ('column', '列框'), ('order', '字序')])%}
                {% for type,text in more[box_type] %}
                <button type="button" class="btn btn-default btn-sm ed-{{type}}-box" title="修改{{text}}">{{text}}</button>
                {% end %}
              </div>
            </div>
            {% end %}
          </div><!--left-->
          <div class="right">
            <div class="m-header-edit-btn">
              {% if not readonly %}
              <img src="{{ static_url('imgs/char_icon8.png') }}" id="save" class="m-header-img btn-save" title="保存" style="margin-left: 40px"/>
              <img src="{{ static_url('imgs/char_icon9.png') }}" id="submit" class="m-header-img btn-submit" title="提交"/>
              <img src="{{ static_url('imgs/char_icon12.png') }}" id="return-task" class="m-header-img btn-return-back" title="退回"/>
              {% end %}
            </div>
          </div><!--right-->
        </div>

        <div class="full-bd {{box_type}}">
          <!-- holder为显示切分框和页面图的画布容器 -->
          <div id="holder"></div>
        </div>

    </div>
  </div>
  </div>

  {% include _base_js.html %}
  <script src="{{ static_url('js/cut/raphael.js') }}"></script>
  <script src="{{ static_url('js/cut/raphael.zoom.js') }}"></script>
  <script src="{{ static_url('js/cut/jquery.mapkey.js') }}"></script>
  <script src="{{ static_url('js/cut/cut.js') }}"></script>
  <script src="{{ static_url('js/cut/cut_keys.js') }}"></script>
  <script src="{{ static_url('js/cut/cut_adv.js') }}"></script>

  <script>
    $.cut.create({
      '{{box_type}}Mode': true,
      removeSmallBoxes: {{int(box_type == 'char' and name[:2] in ['JX'])}},
      name: '{{box_type}}_{{name}}',
      width: {{page['width']}},
      height: {{page['height']}},
      holder: 'holder',
      scrollContainer: '.full-bd',
      image: "{{get_img(page.get('img_name', name), page.get('use_local_img'))}}",
      chars: '{{boxes}}'
    });

    $.cut.bindKeys();

    function updateUndo() {
      $('#undo').toggleClass('disabled', !$.cut.canUndo());
      $('#redo').toggleClass('disabled', !$.cut.canRedo());
    }
    $('#undo').click(function () {
      $.cut.undo();
      updateUndo();
    });
    $('#redo').click(function () {
      $.cut.redo();
      updateUndo();
    });
    updateUndo();

    function showHighLightCount() {
      $('.hl-btn > button').each(function (i, btn) {
        if (i > 0 || {{int(box_type != "char")}}) {
          var type = btn.getAttribute('id').replace(/^.*-/, '');
          var boxes = $.cut.highlightBoxes(type, true);
          $(btn).find('.s-h-count').text(boxes.length);
        }
      });
    }
    showHighLightCount();
    $('.hl-btn > button').click(function () {
      var type = this.getAttribute('id').replace(/^.*-/, '');
      $.cut.switchHighlightBoxes(type);
    });

    $.cut.onBoxChanged(function (char, box, reason) {
      if (reason === 'removed' || reason === 'added' || reason === 'changed') {
        var type = $.cut.data.hlType;
        if (type) {
          $.cut.clearHighlight();
          $.cut.highlightBoxes(type, false, true);
        }
      }
      showHighLightCount();
      updateUndo();
    });

    $('#return-task').click(function () {
      postApi('/task/unlock/{{task_type}}/{{name}}', {}, function (res) {
        if (res.data.length === 1 && res.data[0] === '{{name}}') {
          window.location = '{{from_url}}';
        }
      });
    });

    window.leave = function (url) {
      postApi('/task/unlock/{{task_type}}/{{name}}', {exit: true, from_url: url}, function () {
        window.location = url;
      });
    };

    {% for cut, cls in [('block', '#ed-block-box'), ('column', '#ed-column-box')] %}
      $('{{cls}}').toggleClass('disabled', {{'false' if can_access('/task/my/%s_cut_proof' % cut) or can_access('/task/my/%s_cut_review' % cut) else 'true'}});
      $('{{cls}}').unbind('click').click(function () {
        if (!$(this).hasClass('disabled')) {
          window.location = '/task/do/{{cut}}_cut_{{"proof" if can_access("/task/my/%s_cut_proof" % cut) else "review"}}/{{name}}?view={{int(readonly)}}&from={{request.uri}}';
        }
      });
    {% end %}

    function save(submit) {
      postApi('/task/save/{{task_type}}', {data: {
        submit: submit,
        name: '{{name}}',
        from_url: '{{from_url}}',
        box_type: '{{box_type}}',
        boxes: JSON.stringify($.cut.exportBoxes())
      }}, function (res) {
        showSuccess(res.box_changed ? '保存成功' : '没有改变', '{{name}} ' +
             (!res.box_changed ? '的内容没有改变。' : submit ? '已提交成功。' : '已保存成功。'));
        if (res.jump) {
          setTimeout(function () {
            window.location = res.jump;
          }, 1000);
        }
      });
    }
    $('#save').click(save.bind(null, false));
    $('#submit').click(save.bind(null, true));

    // 修改切分框
    $('.btn-ed-box').click(function () {
        $('.ed-box-group').toggleClass('hidden');
        {% for cut, cls in [('block', '.ed-block-box'), ('column', '.ed-column-box'), ('char', '.ed-char-box')] %}
            $('{{cls}}').toggleClass('disabled', {{'false' if can_access('/task/my/%s_cut_proof' % cut) or can_access('/task/my/%s_cut_review' % cut) else 'true'}});
            $('{{cls}}').unbind('click').click(function () {
                if (!$(this).hasClass('disabled')) {
                    window.location = '/task/do/{{cut}}_cut_{{"proof" if can_access("/task/my/%s_cut_proof" % cut) else "review"}}/{{name}}?from={{request.uri}}';
                }
            });
        {% end %}
    });

  </script>

  </body>
</html>