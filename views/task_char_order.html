<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>字序校对</title>
  {% include _base_meta.html %}

  <!-- Plugins css -->
  <link href="{{ static_url('assets/modal-effect/css/component.css') }}" rel="stylesheet">

  <!-- Custom Files -->
  <link href="{{ static_url('css/helper.css') }}" rel="stylesheet" type="text/css"/>
  <link href="{{ static_url('css/style.css') }}" rel="stylesheet" type="text/css"/>

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
  <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
  <![endif]-->

  {% include _base_css.html %}
  <link href="{{ static_url('css/cut.css') }}" rel="stylesheet" type="text/css"/>

  <style>
    #info {
      position: fixed;
      bottom: 0;
      width: 100%;
      padding: 8px;
      background-color: #fff;
      border-top: 1px solid #ddd;
      opacity: .9;
      color: var(--Color_Brown_Darker);
    }

    #info > span + span {
      margin-left: 8px;
    }

  </style>
</head>

<body class="widescreen">
  <div class="app-main">
    <div class="main">
      <div class="main-content">

        <div class="m-header">
          <div class="left">
            <div class="back">
              <img src='{{ static_url("imgs/icon_back.png") }}' class="m-header-img fl" onclick="leave('{{from_url}}')"/>
            </div>
            <div class="m-header-title" title="{{page['name']}}">字序校对</div>
            <div class="m-header-edit-btn">
              <img src="{{ static_url('imgs/icon_zoom1.png') }}" class="m-header-img btn-enlarge" title="放大"/>
              <img src="{{ static_url('imgs/icon_zoom2.png') }}" class="m-header-img btn-reduce" title="缩小"/>
              <img src="{{ static_url('imgs/icon_lr.png') }}" class="m-header-img btn-undo" title="撤销"/>
              <img src="{{ static_url('imgs/icon_rr.png') }}" class="m-header-img btn-redo" title="重做"/>
            </div>
            <div class="slice-btn-group">
              <div class="btn-group">
                <button type="button" class="btn btn-default btn-sm" id="switch-image" title="显示页面图">背景</button>
                <button type="button" class="btn btn-default btn-sm" id="toggle-columns" title="显示列框">列框</button>
                <button type="button" class="btn btn-default btn-sm" id="toggle-chars" title="显示字框">字框</button>
                <button type="button" class="btn btn-default btn-sm" id="switch-char-no" title="显示字框编号">编号</button>
                <button type="button" class="btn btn-default btn-sm" id="show-err-box" title="显示待修正的字框">查漏</button>
              </div>
            </div>
          </div>
          <div class="m-header-right">
            <div class="m-header-edit-btn">
              <div class="more">
                <div class="btn-group ed-box-group hidden" role="group" aria-label="更多">
                  {% for i, txt in enumerate(['原始字序', '重排(旧算法)', '重排(新算法)']) %}
                  {% set suffix = '?layout=%s%s%s' % (i, '&view=1' if readonly else '', '&from=' + from_url if from_url else '') %}
                  <a class="btn btn-default btn-sm" href='/task/do/char_order_proof/{{name}}{{suffix}}'>{{txt}}</a>
                  {% end %}
                </div>
                <img src="{{ static_url('imgs/icon_box.png') }}" class="m-header-img btn-ed-box fl" title="更多" style="margin: 9px;"/>
              </div>
              {% if not readonly %}
                <img src="{{ static_url('imgs/char_icon8.png') }}" id="save" class="m-header-img btn-save" title="保存"/>
              {% end %}
            </div>
          </div>
        </div>
        <div class="full-bd">
          <!-- holder为显示切分框和页面图的画布容器 -->
          <div id="holder"></div>
          <div id="info">
            <span class="cur-char"></span>
            <span class="col-info"></span>
            <span class="char-info"></span>
            <span class="target-char"></span>
          </div>
        </div>

      </div>
    </div>
  </div>

{% include _base_js.html %}
<script src="{{ static_url('js/cut/raphael.js') }}"></script>
<script src="{{ static_url('js/cut/raphael.zoom.js') }}"></script>
<script src="{{ static_url('js/cut/jquery.mapkey.js') }}"></script>
<script src="{{ static_url('js/cut/cut.js') }}"></script>
<script src="{{ static_url('js/cut/cut_keys.js') }}"></script>
<script src="{{ static_url('js/cut/char_order.js') }}"></script>

<script>
  var columns = decodeJSON('{{page["columns"]}}');
  $.cut.create({
    orderMode: true,
    readonly: true,
    name: '{{name}}_order',
    width: '{{page["width"]}}',
    height: '{{page["height"]}}',
    holder: 'holder',
    scrollContainer: '.full-bd',
    image: "{{get_img(page.get('img_name', name), page.get('use_local_img'))}}",
    chars: '{{page["chars"]}}'
  });

  $.cut.bindKeys();
  $.cut.bindCharOrderKeys();
  $.cut.addCharOrderLinks(decodeJSON('{{chars_col}}'));

  function updateUndo() {
    $('#undo').toggleClass('disabled', !$.cut.canUndo());
    $('#redo').toggleClass('disabled', !$.cut.canRedo());
  }
  $('#undo').click(function () {
    $.cut.undo();
    updateUndo();
  });
  $('#redo').click(function () {
    $.cut.redo();
    updateUndo();
  });

  $.cut.onBoxChanged(function (char, box, reason) {
    if (reason === 'navigate') {
    $('#info > .cur-char').text('当前字框: ' + ($.cut.getCurrentCharID() || '未选中'));
    }
    updateUndo();
  });

  $('#switch-image').click(function () {
    var style = $.cut.data.image.node.style;
    style.display = style.display === 'none' ? '' : 'none';
  });

  window.leave = function (url) {
    postApi('/task/unlock/{{task_type}}/{{name}}', {exit: true, from_url: url}, function () {
    window.location = url;
    });
  };

  function save(submit) {
    postApi('/task/save/{{task_type}}', {data: {
    submit: submit,
    name: '{{name}}',
    from_url: '{{from_url}}',
    box_type: '{{box_type}}',
    boxes: JSON.stringify($.cut.exportBoxes())
    }}, function (res) {
    showSuccess(res.box_changed ? '保存成功' : '没有改变', '{{name}} ' +
       (!res.box_changed ? '的内容没有改变。' : submit ? '已提交成功。' : '已保存成功。'));
    if (res.jump) {
      setTimeout(function () {
      window.location = res.jump;
      }, 1000);
    }
    });
  }
  $('#save').click(save.bind(null, false));
  $('#submit').click(save.bind(null, true));

  updateUndo();

  // 显示字序待修正的字框
  $('#show-err-box').click(function () {
    $.cut.showErrorBoxes(true);
  });
  setTimeout(function () {
    $.cut.showErrorBoxes();
  }, 100);

  // 显隐列框
  $('#toggle-columns').click(function () {
    $.cut.toggleColumns(columns);
  })

  // 显隐字框
  $('#toggle-chars').click(function () {
    $.cut.toggleBox('hide');
  })

  // 更多操作
  $('.btn-ed-box').click(function () {
    $('.ed-box-group').toggleClass('hidden');
  });

</script>

</body>
</html>