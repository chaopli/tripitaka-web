<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>任务管理-切分任务状态</title>
		{% include _base_meta.html %}

		<!-- DataTables -->
		<link href="{{ static_url('assets/datatables/jquery.dataTables.min.css') }}" rel="stylesheet" type="text/css" />
		<!-- Custom Files -->
		<link href="{{ static_url('css/helper.css') }}" rel="stylesheet" type="text/css" />
		<link href="{{ static_url('css/style.css') }}" rel="stylesheet" type="text/css" />
		{% include _base_css.html %}
		<link href="{{ static_url('assets/jquery-multi-select/multi-select.css') }}"  rel="stylesheet" type="text/css" />
		<link href="{{ static_url('assets/select2/select2.css') }}" rel="stylesheet" type="text/css" />

		<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
		<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
		<!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

		<style>
			.collate-history .collate-list table tbody tr td.status_none {
				color: #999;
			}
			.collate-history .collate-list table tbody tr td.status_pending {
				color: #666;
			}
			.collate-history .collate-list table tbody tr td.status_ended {
				color: #0f0;
			}
			.collate-history .collate-list table tbody tr td.status_opened {
				color: #007;
			}
		</style>
	</head>
	<style>

	</style>

	<body>
		<div class="app-main">
			<div class="main">
				<!--模拟出左边菜单，方便写样式-->
				{% module CommonLeft(title="task-manage", sub="task-manage-cut-status" ) %}
				<div class="main-content">
					{% module CommonHead() %}
					<div class="single-page-con">
						<div class="layout">
							<div class="layout-content">
								<div class="collate-history">
									<div class="wrapper">
										<div class="collate-list">
											<div class="search fr">
												<input type="text" placeholder="搜索">
												<i class="ser-btn"></i>
											</div>
											<table style="border-collapse:separate; border-spacing:0px 10px;" class="sty_table">
												<thead>
													<tr>
														<th><input type="checkbox" name="" id=" " value="" /></th>
														<th><span>页编码</span></th>
														{% for i, item in enumerate(['文字校一','文字校二','文字校三','文字审定']) %}
														<th>
															<div class="btn-group">
																<span class="sort" data-toggle="dropdown" aria-expanded="false">{{item}}</span>
																<span class="ion-android-sort "></span>
																<ul class="dropdown-menu" role="menu">
																	{% for k, v in task_statuses.items() %}
																	<li><a href="{{current_url}}?status={{k}}&t={{['text_proof.1', 'text_proof.2', 'text_proof.3', 'text_review'][i]}}">{{v}}</a></li>
																	{% end %}
																</ul>
															</div>
														</th>
														{% end %}
													</tr>
												</thead>

												<tbody>
												  {% for t in tasks %}
													<tr id="{{t['name']}}">
														<td><input type="checkbox" name="" id="" value="" /></td>
														<td>{{t['name']}}</td>
														<td class="">{{task_statuses.get(t['text_proof']['1']['status'],{})}}</td>
														<td class="">{{task_statuses.get(t['text_proof']['2']['status'],{})}}</td>
														<td class="">{{task_statuses.get(t['text_proof']['3']['status'],{})}}</td>
														<td class="">{{task_statuses.get(t['text_review']['status'],{})}}</td>
													</tr>
												  {% end %}
												</tbody>
											</table>
										</div>
										{% module Pager(pager='TODO') %}
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		{% include _base_js.html %}
		<script src="{{ static_url('assets/select2/select2.min.js') }}" type="text/javascript"></script>
		<script type="text/javascript" src="{{ static_url('assets/jquery-multi-select/jquery.multi-select.js') }}"></script>
        <script type="text/javascript" src="{{ static_url('assets/jquery-multi-select/jquery.quicksearch.js') }}"></script>
		<script type="text/javascript">

			var pages = [];
			var $modal = $('#selectModal');

			// 勾选发布任务
			$modal.on('shown.bs.modal', function () {
				postApi('/pages/cut_start', {data: {}}, function (res) {
					pages = res.items;
					$('#selectModal .ms-selectable:first-of-type ul').html(pages.map(function (p) {
						return '<li class="ms-elem-selectable" id="' + p + '"><span>' + p + '</span></li>';
					}).join('\n'));
				});
			});

			$modal.find('.btn-primary').click(function () {
				var types = [];
				$modal.find('.task_types input').each(function (i, input) {
					input = $(input);
					if (input.is(':checked')) {
						types.push(input.attr('id'));
					}
				});
				if (!types.length) {
					return showError('未选任务类型', '请勾选一个或多个任务类型。')
				}
				postApi('/start/', {
					data: {
						priority: $('.priority-list select').val(),
						types: types.join(','),
						pages: pages.join(',')
					}
				}, function (res) {
					showSuccess('已发布任务', res.names.length + ' 个页面、' + res.items.length + ' 个任务已发布。');
					setTimeout(function () {
						location.reload();
					}, 1000);
				});

			});

			$('#my_multi_select').multiSelect({
                    selectableHeader: "待选对象<input type='text' class='form-control search-input' id='selectable_input' placeholder='您可以输入关键字进行搜索'>",
                    selectionHeader: "已选对象<input type='text' class='form-control search-input' id='selected_input' placeholder='您可以输入关键字进行搜索'>",
                    selectableFooter: "<a href='javascript:void(0);' class='left_btn' id='select_all_btn'>全选</a><a href='javascript:void(0);' class='right_btn' id='select_all_search_btn'>全选所有搜索结果</a>",
                    selectionFooter: "<a href='javascript:void(0);' class='left_btn' id='deselect_all_btn'>全删</a><a href='javascript:void(0);' class='right_btn' id='deselect_all_search_btn'>删除所有搜索结果</a>",
                    selectableOptgroup:true,
                    afterSelect:function(val){
                    		console.log(val);
                    }
                });
            var selectableArr = [];
            var deSelectableArr = [];
            $("#selectable_input").on('input propertychange',function(){
            		var inputval = $(this).val().trim();
            		var selections = $("#my_multi_select").siblings('.ms-container').find('.ms-selectable li.ms-elem-selectable');
            		selectableArr = [];
            		selections.each(function(){
            			var item_value = $(this).text();
            			if(item_value.match(inputval)){
            				$(this).show();
            				selectableArr.push(item_value);
            			}else{
            				$(this).hide();
            			}
            		});
            		$(".ms-elem-selectable.ms-selected").hide();
            		console.log(selectableArr);
            });
            $("#selected_input").on('input propertychange',function(){
            		var inputval = $(this).val().trim();
            		var selections = $("#my_multi_select").siblings('.ms-container').find('.ms-selection .ms-elem-selection.ms-selected');
            		deSelectableArr = [];
            		selections.each(function(){
            			var item_value = $(this).text();
            			if(item_value.match(inputval)){
            				$(this).show();
            				deSelectableArr.push(item_value);
            			}else{
            				$(this).hide();
            			}
            		})
            		console.log(deSelectableArr);
            });
			$('#select_all_search_btn').click(function(){
				if(selectableArr.length>0){
					$('#my_multi_select').multiSelect('select',selectableArr);	
				}else{
					alert("没有搜索结果");
				}
			});
			$('#deselect_all_search_btn').click(function(){
				if(deSelectableArr.length>0){
					$('#my_multi_select').multiSelect('deselect',deSelectableArr);	
				}else{
					alert("没有搜索结果");
				}
			});
			$("#select_all_btn").click(function(){
				$('#my_multi_select').multiSelect('select_all');
			});
			$("#deselect_all_btn").click(function(){
				$('#my_multi_select').multiSelect('deselect_all');
			});
			$("#select_modal_btn").click(function(){
				var selections = $("#my_multi_select").siblings('.ms-container').find('.ms-selection .ms-elem-selection.ms-selected');
            		deSelectableArr = [];
            		selections.each(function(){
            			var item_value = $(this).text();
            			deSelectableArr.push(item_value);
            		})
            		console.log(deSelectableArr);
			})
		</script>
	</body>

</html>